<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Read Aloud Practice</title>
    <style>
        #textAreaContainer {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background-color: white;
            padding: 10px;
            border: 1px solid black;
            z-index: 10000;
        }
        #input_text {
            width: 100%;
            margin-bottom: 10px;
        }
        #final_output {
            margin-top: 10px;
            color: green;
        }
        #interim_output {
            margin-top: 10px;
            color: gray;
        }
        #toggle_button {
            margin-top: 10px;
        }
        .speava_button_active {
        background-color: #ac2925;
    }
    </style>
</head>
<!--
////////////////////////////////////////////////////////////////////////////
// This standalone "Read aloud" page runs in the browser without extension
// The code that is used in the extension is copied to this page so that
//   the dev team will maintain the site more easily
////////////////////////////////////////////////////////////////////////////
-->
<body onload="loading_text();">
    <div id="textAreaContainer">
        <textarea id="input_text" placeholder="Paste your text here and start reading aloud..." rows="10" cols="50"></textarea>
        <div id="final_output"></div>
        <div id="interim_output"></div>
        <button id="update_content_via_textbox_content" onclick="update_content_via_textbox_content()">Start Practices</button>
        <button id="skip_and_forward" onclick="skip_and_forward()">Skip and forward</button>
    </div>
    <div id="main_container">
<p>Paste text you like to practice with.</p>
    </div>
    <script>
        function update_content_via_textbox_content(){
            let content_new = document.getElementById("input_text").value;
            content_new = content_new.replaceAll("\n","</p><p>")
            document.getElementById("main_container").innerHTML = "<p>" + content_new + "</p>";
            current_item_in_list = 0;
            current_sequence_number_in_item = 0;
        }
        function skip_and_forward(){
            current_sequence_number_in_item++;
        }
                ////////////////////////////////////////////////////////////////////////////
                // Variables (hardcoded)
                ////////////////////////////////////////////////////////////////////////////
                let is_synced = false;
                let background_color = "#000000";
                let text_color = "#FFFFFF";
                let tab_text_array = ['p'];

                ////////////////////////////////////////////////////////////////////////////
                // Variables
                ////////////////////////////////////////////////////////////////////////////
                let read_list_of_elements = [];
                let last_selected_fragment = null;
                let current_item_in_list = 0;
                let current_sequence_number_in_item = 0;
                let current_sequence_number_in_item_from = 0;
                let current_sequence_number_in_item_to = 0;
                let target_text = "";
                let interimTranscriptReadAloud = "";
                let current_selected_from = 0;
                let current_selected_to = 0;
                let isTranscribing = false;
                let isTextAreaCreated = null;
                let buttons = null;
                let caption_lines = [];
                // let tab_text_array = ['div'];

                // let text_color;

                let SpeechRecognition;
                let recognition;
                let finalTranscript = '';

                let speava_select_language;
                const langs = [['Afrikaans', ['af-ZA']], ... /* shortened for brevity */ ['ภาษาไทย', ['th-TH']]];

                ////////////////////////////////////////////////////////////////////////////
                // Constants
                ////////////////////////////////////////////////////////////////////////////

                const LOCALSTORAGE_VERSION = 1;
                let DEBUG;

        function loading_text(){

        try {
            ;(() => {
                // ////////////////////////////////////////////////////////////////////////////
                // // Variables
                // ////////////////////////////////////////////////////////////////////////////
                // let read_list_of_elements = [];
                // let last_selected_fragment = null;
                // let current_item_in_list = 0;
                // let current_sequence_number_in_item = 0;
                // let current_sequence_number_in_item_from = 0;
                // let current_sequence_number_in_item_to = 0;
                // let target_text = "";
                // let interimTranscriptReadAloud = "";
                // let current_selected_from = 0;
                // let current_selected_to = 0;
                //
                // let isTranscribing = false;
                // let isTextAreaCreated = null;
                // let buttons = null;
                // let caption_lines = [];
                // let tab_text_array = [];
                //
                // let text_color;
                //
                // let SpeechRecognition;
                // let recognition;
                // let finalTranscript = '';
                //
                // let speava_select_language;
                // const langs = [['Afrikaans', ['af-ZA']], ... /* shortened for brevity */ ['ภาษาไทย', ['th-TH']]];
                //
                // ////////////////////////////////////////////////////////////////////////////
                // // Constants
                // ////////////////////////////////////////////////////////////////////////////
                //
                // const LOCALSTORAGE_VERSION = 1;
                // let DEBUG;

                const makeFullKey = (key, version = LOCALSTORAGE_VERSION) => {
                    let versionPostfix = version === null ? '' : `_v${version}`;
                    return `__gmla${versionPostfix}_${key}`;
                };

                const get = (key, version) => {
                    const raw = window.localStorage.getItem(makeFullKey(key, version));
                    if (typeof raw === 'string' || raw instanceof String) {
                        debug(key, raw);
                        return JSON.parse(raw);
                    } else {
                        return raw;
                    }
                };

                const set = (key, value, version) => {
                    window.localStorage.setItem(makeFullKey(key, version), JSON.stringify(value));
                };

                const remove = (key, version) => {
                    debug(`remove ${makeFullKey(key, version)}`);

                    if (!READONLY) {
                        window.localStorage.removeItem(makeFullKey(key, version));
                    }
                };

                const getOrSet = (key, defaultValue, version) => {
                    const value = get(key, version);

                    if (value === undefined || value === null) {
                        set(key, defaultValue, version);
                        return defaultValue;
                    } else {
                        return value;
                    }
                }

                const increment = (key, version) => {
                    const current = get(key, version);

                    if (current === undefined || current === null) {
                        set(key, 0);
                        return 0;
                    } else {
                        let next = current + 1;
                        set(key, next);
                        return next;
                    }
                }

                ////////////////////////////////////////////////////////////////////////////
                // DOM Utilities
                ////////////////////////////////////////////////////////////////////////////

                const xpath = (search, root = document) => {
                    return document.evaluate(search, root, null, XPathResult.FIRST_ORDERED_NODE_TYPE).singleNodeValue;
                };

                // const getAllStorageSyncData = () => {
                //     return new Promise((resolve) => {
                //         chrome.storage.sync.get({
                //             window_positions: '{"z_index":"65000","elem_others.style.width":"1000px","elem_others.style.top":"300px","fixed_part_of_utterance.style.width":"800px","buttons.style.top":"100px"}',
                //             text_color: "#FFFFFF",
                //             background_color: "#000000",
                //             tab_text: 'you know\nyeah\nlike',
                //             speava_select_language: "en-US"
                //         }, (items) => {
                //             is_synced = true
                //             if (chrome.runtime.lastError) {
                //                 return reject(chrome.runtime.lastError);
                //             }
                //             window_positions = items.window_positions;
                //             text_color = items.text_color;
                //             background_color = items.background_color;
                //             tab_text = items.tab_text;
                //             speava_select_language = items.speava_select_language;
                //             setTextArray(tab_text);
                //             applyFontColor(text_color, background_color);
                //             applyOptionStyles();
                //         });
                //     });
                // }

                const debug = (...args) => {
                    if (DEBUG) {
                        console.log('[google-meet-live-analytics]', ...args);
                    }
                };

                const tryTo = (fn, label) => async (...args) => {
                    try {
                        return await fn(...args);
                    } catch (e) {
                        console.error(`error ${label}:`, e);
                    }
                };

                // const open_option_dialog = () => {
                //     if (chrome.runtime.openOptionsPage) {
                //         chrome.runtime.openOptionsPage();
                //     } else {
                //         let dialog = document.createElement('dialog');
                //         let request = new Request(chrome.runtime.getURL('options.html'));
                //         fetch(request).then(function (response) {
                //             return response.text().then(function (text) {
                //                 dialog.innerHTML = text;
                //
                //                 dialog.oncancel = function () {
                //                     dialog.remove();
                //                 }
                //                 const update_select_language = () => {
                //                     const speava_select_language = document.getElementById('select_language');
                //                     for (var i = 0; i < langs.length; i++) {
                //                         speava_select_language.options[i] = new Option(langs[i][0], i);
                //                     }
                //                     updateCountry();
                //                 }
                //                 const save_options = () => {
                //                     window_positions = document.getElementById('window_positions').value;
                //                     text_color = document.getElementById('text_color').value;
                //                     background_color = document.getElementById('background_color').value;
                //                     tab_text = document.getElementById('tab_text').value;
                //                     var element_speava_select_language = document.getElementById('select_language');
                //                     var element_speava_select_dialect = document.getElementById('select_dialect');
                //                     var speava_select_language_value = langs[element_speava_select_language.options.selectedIndex];
                //                     speava_select_language = element_speava_select_dialect.value;
                //
                //                     applyFontColor(text_color, background_color);
                //                     applyOptionStyles();
                //                     setTextArray(tab_text);
                //                     chrome.storage.sync.set({
                //                         window_positions: window_positions,
                //                         text_color: text_color,
                //                         background_color: background_color,
                //                         tab_text: tab_text,
                //                         speava_select_language: speava_select_language
                //                     }, function () {
                //                         var status = document.getElementById('status');
                //                         status.textContent = 'Options saved.';
                //                         setTimeout(function () {
                //                             status.textContent = '';
                //                             dialog.remove();
                //                         }, 750);
                //                     });
                //                 }
                //                 const updateCountry = () => {
                //                     const speava_select_language = document.getElementById('select_language');
                //                     const speava_select_dialect = document.getElementById('select_dialect');
                //                     for (var i = speava_select_dialect.options.length - 1; i >= 0; i--) {
                //                         speava_select_dialect.remove(i);
                //                     }
                //                     var list = langs[speava_select_language.selectedIndex];
                //                     for (var i = 1; i < list.length; i++) {
                //                         speava_select_dialect.options.add(new Option(list[i][1], list[i][0]));
                //                     }
                //                     speava_select_dialect.style.visibility = list[1].length == 1 ? 'hidden' : 'visible';
                //                 }
                //                 const list_of_codes = (language_code) => {
                //                     let list_code = [];
                //                     let list_counter = -1;
                //                     let found_at = 0;
                //                     langs.forEach(item => {
                //                         if (item[1].length === 1) {
                //                             list_counter++;
                //                             if (item[1][0] === language_code) {
                //                                 found_at = list_counter;
                //                             }
                //
                //                         } else {
                //                             list_counter++;
                //                             item.forEach(subitem => {
                //                                 if (subitem.length === 2) {
                //                                     if (subitem[0] === language_code) {
                //                                         found_at = list_counter;
                //                                     }
                //                                 }
                //                             })
                //                         }
                //                     });
                //                     return found_at;
                //                 }
                //                 const restore_options = () => {
                //                     chrome.storage.sync.get({
                //                         window_positions: '{"z_index":"65000","elem_others.style.width":"1000px","elem_others.style.top":"300px","fixed_part_of_utterance.style.width":"800px","buttons.style.top":"100px"}',
                //                         text_color: "#FFFFFF",
                //                         background_color: "#000000",
                //                         tab_text: 'you know\nyeah\nlike',
                //                         speava_select_language: 'en-US'
                //                     }, function (items) {
                //                         document.getElementById('window_positions').value = items.window_positions;
                //                         document.getElementById('text_color').value = items.text_color;
                //                         document.getElementById('background_color').value = items.background_color;
                //                         document.getElementById('tab_text').value = items.tab_text;
                //                         const item_number = list_of_codes(items.speava_select_language);
                //                         document.getElementById('select_language').value = item_number;
                //                         updateCountry();
                //                         document.getElementById('select_dialect').value = items.speava_select_language;
                //
                //                     });
                //                 }
                //                 document.body.appendChild(dialog);
                //                 dialog.showModal();
                //                 update_select_language();
                //                 restore_options();
                //                 document.getElementById('option_save').addEventListener('click',
                //                     save_options);
                //             });
                //         });
                //     }
                // }

                const turnCaptionsOn_adhoc = () => {
                    recognition.lang = speava_select_language;
                    const captionsButtonOn = xpath(`//button[@id="webkit_speech_recognition_toggle"]`, document);
                    if (captionsButtonOn) {
                        if (!captionsButtonOn.classList.contains("speava_button_active")) {
                            captionsButtonOn.classList.add("speava_button_active");
                            recognition.start()
                        }
                        weTurnedCaptionsOn = true;
                    }
                }

                const turnCaptionsOff_adhoc = () => {
                    const captionsButtonOff = xpath(`//button[@id="webkit_speech_recognition_toggle"]`, document);
                    if (captionsButtonOff) {
                        if (captionsButtonOff.classList.contains("speava_button_active")) {
                            captionsButtonOff.classList.remove("speava_button_active");
                        }
                        weTurnedCaptionsOn = false;
                    }
                    recognition.stop();
                }

                const addButtons = () => {
                    // if (is_synced === null) {
                    //     return;
                    // }
                    if (isTextAreaCreated === null) {
                        const elem = document.createElement('div');
                        elem.id = "space_textarea";
                        elem.style.top = "0px"
                        elem.style.witdh = "300px"
                        elem.style.font.fontcolor(text_color);
                        const text = document.createTextNode('Show stats');
                        const objBody = document.getElementsByTagName("body").item(0);

                        const elem_others = document.createElement('div');
                        elem_others.id = "all_others";
                        elem_others.style.position = 'absolute';
                        elem_others.innerText = 'Place holder for heading';
                        objBody.appendChild(elem_others);

                        const elem_others_number = document.createElement('div');
                        elem_others_number.id = "counting_number";
                        elem_others_number.innerText = 'Place holder for number';
                        elem_others.appendChild(elem_others_number);

                        const toggle_button_div = document.createElement('div');
                        const toggle_button = document.createElement('button');
                        toggle_button.setAttribute('id', `webkit_speech_recognition_toggle`)
                        toggle_button.innerText = "caption on/off";
                        toggle_button.setAttribute('class', "speava_button");
                        toggle_button.onclick = () => {
                            isTranscribing ? stopTranscribing() : startTranscribing()
                            isTranscribing = !isTranscribing;
                        }
                        toggle_button_div.appendChild(toggle_button);
                        elem_others.appendChild(toggle_button_div);

                        const elem_transcript = document.createElement('div');
                        elem_transcript.id = "fixed_part_of_utterance";
                        const elem_interim = document.createElement('div');
                        elem_interim.id = "interim_part_of_utterance";

                        elem_others.appendChild(elem_transcript);
                        elem_others.appendChild(elem_interim);
                        SpeechRecognition = SpeechRecognition || webkitSpeechRecognition;

                        recognition = new SpeechRecognition();
                        recognition.lang = "en"// speava_select_language;
                        recognition.interimResults = true;
                        recognition.continuous = true;
                        recognition.onresult = (event) => {
                            const fixed_part_of_utterance = document.getElementById('fixed_part_of_utterance');
                            const interim_part_of_utterance = document.getElementById('interim_part_of_utterance');
                            let interimTranscript = '';
                            let alternating_sub_zero = 0;
                            let index = fixed_part_of_utterance.speava_index;
                            if (index === undefined) {
                                index = -1;
                                fixed_part_of_utterance.speava_index = -1;
                                fixed_part_of_utterance.latest_trascript_part = "";
                                fixed_part_of_utterance.speava_index += 1;
                            }
                            for (let i = event.resultIndex; i < event.results.length; i++) {
                                let transcript = event.results[i][0].transcript;
                                if (event.results[i].isFinal) {
                                    finalTranscript += "<br>" + transcript;
                                    finalTranscript = finalTranscript.split("<br>").slice(finalTranscript.split("<br>").length - 2, finalTranscript.split("<br>").length).join("<br>")
                                    fixed_part_of_utterance.speava_index = -1;
                                    fixed_part_of_utterance.latest_trascript_part = "";
                                    interimTranscriptReadAloud = "";
                                } else {
                                    interimTranscript = transcript;
                                    interimTranscriptReadAloud = interimTranscript;
                                    check_and_progress();
                                    for (let item of tab_text_array) {
                                        let input_string = " " + interimTranscript.toLowerCase() + " "
                                        let comparing_string = " " + item.toLowerCase() + " ";
                                        if (input_string.indexOf(comparing_string) != -1) {
                                            toast_to_notify(item, 2000);
                                        }
                                    }

                                    if (transcript.length >= 100) {
                                        finalTranscript += "<br>" + transcript;
                                        finalTranscript = finalTranscript.split("<br>").slice(finalTranscript.split("<br>").length - 2, finalTranscript.split("<br>").length).join("<br>")
                                        fixed_part_of_utterance.speava_index = -1;
                                        fixed_part_of_utterance.latest_trascript_part = "";
                                        fixed_part_of_utterance.innerHTML = '<style="color:'
                                            + text_color + ';">' + finalTranscript + '</>';
                                        interim_part_of_utterance.innerHTML = '';
                                        recognition.stop()
                                    }
                                    if (index === -1) {
                                        fixed_part_of_utterance.speava_index += 1;
                                    } else {
                                        let setSpeaker_done = false;
                                        if ((fixed_part_of_utterance.latest_trascript_part === "") || (transcript.split(" ").length >= 5)) {
                                            if ((transcript.split(" ").length >= 5) &&
                                                (transcript.split(" ").length >= fixed_part_of_utterance.latest_trascript_part.split(" ").length)) {
                                                fixed_part_of_utterance.latest_trascript_part = transcript;
                                            }
                                        }
                                        if (setSpeaker_done === false && (transcript.split(" ").length === 1) && (transcript.length >= 10)) {
                                            let current_time = new Date();
                                            let current_sub_zero = current_time.getMilliseconds() + 1;
                                            current_sub_zero = Math.floor(current_sub_zero / 100);
                                            if ((current_sub_zero === 0) || (current_sub_zero === 5)) {
                                                if (alternating_sub_zero !== current_sub_zero) {
                                                    alternating_sub_zero = current_sub_zero;
                                                    fixed_part_of_utterance.latest_trascript_part = transcript;
                                                }
                                            }
                                        }
                                    }

                                }
                            }
                            fixed_part_of_utterance.innerHTML = '<style="color:'
                                + text_color + ';">' + finalTranscript + '</>';
                            interim_part_of_utterance.innerHTML = '<i style="color:'
                                + text_color + ';">' + interimTranscript + '</i>';
                        }

                        recognition.onerror = function (e) {
                            console.log(e);
                        }
                        recognition.onend = function (e) {
                            console.log("voice recognition terminated");
                            console.log(e);
                            if (isTranscribing === true) {
                                recognition.lang = speava_select_language;
                                recognition.start();
                                toggle_button.classList.add('speava_button_active');
                            } else {
                                toggle_button.classList.remove('speava_button_active')
                                isTranscribing = false;
                            }
                        };

                        let finalTranscript = "Initial load";

                        fixed_part_of_utterance.innerHTML = '<style="color:'
                            + text_color + ';">' + finalTranscript + '</>';

                        isTextAreaCreated = true;

                        const objBody_buttons = document.getElementsByTagName("body").item(0);
                        buttons = document.createElement('div');
                        isShowing = true;
                        buttons.id = "buttons";
                        buttons.style.position = 'absolute';
                        objBody_buttons.appendChild(buttons);

                        // const url_icon_config = chrome.runtime.getURL("icons/icon_config.png");
                        const open_options = () => open_option_dialog();
                        const _PNG_CONFIG = {
                            viewBoxWidth: 448,
                            viewBoxHeight: 512,
                            // path: url_icon_config,
                        };
                        const configButton = document.createElement('div');
                        buttons.prepend(configButton);
                        configButton.style.display = 'flex';
                        configButton.style.position = 'relative';
                        configButton.style.float = 'left';
                        configButton.appendChild(makePng(_PNG_CONFIG, 36, 36, { id: "config", onclick: open_options }));

                        applyFontColor(text_color, background_color);
                        applyOptionStyles();
                        addReadAloudElements(tab_text_array[0]);
                    }

                };

                const setTextArray = (inText) => {
                    const dataArray = [];
                    let procssing_text = inText;
                    procssing_text = procssing_text.replace('\r\n', '\n');
                    procssing_text = procssing_text.replace('\n\r', '\n');
                    const dataString = procssing_text.split('\n');
                    tab_text_array = dataString;
                }

                ////////////////////////////////////////////////////////////////////////////
                // read aloud
                ////////////////////////////////////////////////////////////////////////////

                // let read_list_of_elements = [];
                // let last_selected_fragment = null;
                // let current_item_in_list = 0;
                // let current_sequence_number_in_item = 0;
                // let current_sequence_number_in_item_from = 0;
                // let current_sequence_number_in_item_to = 0;
                // let target_text = "";
                // let interimTranscriptReadAloud = "";
                // let current_selected_from = 0;
                // let current_selected_to = 0;

                const addReadAloudElements = (inTag) => {
                    read_list_of_elements = [];
                    const list_of_tag_elements = document.getElementsByTagName(inTag);
                    for (let item of list_of_tag_elements) {
                        read_list_of_elements.push([item, item.innerHTML]);
                    }
                    document.addEventListener('selectionchange', (e) => {
                        const selected_node = window.getSelection();
                        // if (selected_node.anchorNode.id != "main_container"){
                        //     return true;
                        // }
                        const selected_text = selected_node.anchorNode.wholeText.substring(selected_node.anchorOffset, selected_node.focusOffset)
                        console.log("Archor node - ", selected_node);
                        console.log("Archor node - ", selected_text);
                        last_selected_fragment = selected_node;
                        for (let item of list_of_tag_elements) {
                            if (item[0] == e.target) {
                                console.log("found target", e.target);
                            }
                        }

                    });
                    document.addEventListener('click', function (e) {
                        console.log("click event", e);
                        if (e.target.tagName == "BUTTON") {
                            if (e.target.id == "update_content_via_textbox_content"){
                                update_content_via_textbox_content();
                                addReadAloudElements(tab_text_array[0]);
                            }
                            return true;
                        }
                        if (e.target.tagName == "TEXTAREA") {
                            return true;
                        }
                        // last_selected_fragment = e.target.anchorNode.wholeText;
                        if (e.target.tagName != inTag.toUpperCase()) {
                            current_item_in_list = 0;
                            current_sequence_number_in_item = 0;
                            current_sequence_number_in_item_from = 0;
                            current_sequence_number_in_item_to = 0;
                            target_text = "";
                            interimTranscriptReadAloud = "";
                            current_selected_from = 0;
                            current_selected_to = 0;
                            window.alert("clicked an irrelevant element");
                            return;
                        }
                        e.target.style.outline = "solid blue 1px";

                        let item_count = 0;
                        for (let item of read_list_of_elements) {
                            if (item[0] == e.target) {
                                console.log("found target", e.target);
                                console.log("fragment", last_selected_fragment);
                                let char_from = last_selected_fragment.anchorOffset;
                                let char_to = last_selected_fragment.focusOffset;
                                if (char_from == char_to) {
                                    if (current_selected_to != 0 && current_selected_to !== undefined) {
                                        const current_node = read_list_of_elements[current_item_in_list][0];
                                        current_node.innerHTML = read_list_of_elements[current_item_in_list][1];
                                        current_item_in_list = 0;
                                        current_sequence_number_in_item = 0;
                                        current_sequence_number_in_item_from = 0;
                                        current_sequence_number_in_item_to = 0;
                                        target_text = "";
                                        interimTranscriptReadAloud = "";
                                        current_selected_from = 0;
                                        current_selected_to = 0;
                                        window.alert("selection reseted");
                                        return;
                                    }
                                    current_item_in_list = item_count;

                                }
                                if (char_from < char_to) {
                                    [char_to, char_from] = [char_from, char_to];
                                }

                                const selected_text = last_selected_fragment.anchorNode.wholeText.substring(char_from, char_to);
                                current_selected_from = 0;
                                current_selected_to = 0;
                                if (item[1].indexOf(selected_text) != -1) {
                                    current_selected_from = item[1].indexOf(selected_text);
                                    current_selected_to = current_selected_from + selected_text.length;
                                    current_sequence_number_in_item_from = item[1].substring(0, current_selected_from).split(" ").length - 1;
                                    current_sequence_number_in_item = current_sequence_number_in_item_from;
                                    current_sequence_number_in_item_to = item[1].substring(0, current_selected_to).split(" ").length - 1;
                                }

                                current_item_in_list = item_count;
                                if ((last_selected_fragment.focusOffset - last_selected_fragment.anchorOffset) >= 3) {
                                    target_text = selected_text;
                                } else {
                                    target_text = item[0].innerText;
                                }
                                return;
                            }
                            item_count += 1;
                        }
                    });
                }

                const check_and_progress = () => {
                    const all_others = document.getElementById("counting_number");
                    let text_of_the_progresses = 0;
                    text_of_the_progresses = "At:" + current_item_in_list.toString() + ""

                    const current_node = read_list_of_elements[current_item_in_list][0];
                    let inPartText = interimTranscriptReadAloud;
                    inPartText = inPartText.trim();
                    if (current_node === undefined || current_node === null) {
                        all_others.innerText = text_of_the_progresses;
                        return;
                    }

                    const list_words = current_node.innerText.split(" ");
                    if (list_words.length == 1) {
                        if (read_list_of_elements.length > current_item_in_list){
                            current_item_in_list++;
                            return;
                        }
                    }
                    let the_word_to_highlight = list_words[current_sequence_number_in_item];
                    if (the_word_to_highlight === undefined) {
                        all_others.innerText = text_of_the_progresses;
                        return;
                    }
                    let deltaNumberOfWords = 0;
                    const split_inPartText = inPartText.split(" ");
                    if (inPartText == "") {
                        list_words[current_sequence_number_in_item + deltaNumberOfWords] = "<span style='color:blue'>" + list_words[current_sequence_number_in_item + deltaNumberOfWords] + "</span>";
                    } else {
                        for (let item of split_inPartText) {
                            let base_string = " " + the_word_to_highlight.toLowerCase().trim().replace(/[^a-z]/g, '') + " ";
                            let compara_string = item.toLowerCase().trim().replace(/[^a-z]/g, '');
                            if (base_string.indexOf(compara_string) != -1) {
                                list_words[current_sequence_number_in_item + deltaNumberOfWords] = "<span style='opacity:50%'>" + list_words[current_sequence_number_in_item + deltaNumberOfWords] + "</span>";
                                deltaNumberOfWords += 1;
                                the_word_to_highlight = list_words[current_sequence_number_in_item + deltaNumberOfWords];
                            } else if ((base_string.replaceAll(" ", "").length) == 0) {
                                deltaNumberOfWords += 1;
                            } else {
                                list_words[current_sequence_number_in_item + deltaNumberOfWords] = "<span style='color:red'>" + list_words[current_sequence_number_in_item + deltaNumberOfWords] + "</span>";
                            }
                        }
                    }
                    current_sequence_number_in_item = current_sequence_number_in_item + deltaNumberOfWords;

                    if (current_sequence_number_in_item_to == 0) {
                        const max_of_words_in_block = list_words.length;
                        if (current_sequence_number_in_item == max_of_words_in_block) {
                            if (current_item_in_list < read_list_of_elements.length) {
                                current_item_in_list += 1;
                                current_sequence_number_in_item = 0;
                            } else {
                                current_item_in_list = 0;
                            }
                        }
                    } else {
                        if (current_sequence_number_in_item_to < current_sequence_number_in_item) {
                            current_sequence_number_in_item = current_sequence_number_in_item_from;
                        }
                    }
                    let replacing_HTML = list_words.join(" ");
                    current_node.innerHTML = replacing_HTML;
                    text_of_the_progresses = "At:" + current_item_in_list.toString() + " / word:" + current_sequence_number_in_item.toString()
                        + ` / ${current_selected_from} to ${current_selected_to} / `
                        + `${current_sequence_number_in_item_from} to ${current_sequence_number_in_item_to}`;
                    all_others.innerText = text_of_the_progresses;
                }

                ////////////////////////////////////////////////////////////////////////////
                // Transcribing Controls
                ////////////////////////////////////////////////////////////////////////////

                const stopTranscribing = () => {
                    turnCaptionsOff_adhoc();
                }

                const startTranscribing = () => {
                    turnCaptionsOn_adhoc();
                }

                const makePng = ({ viewBoxWidth, viewBoxHeight, path }, widthPx, heightPx, options = {}) => {
                    const png = document.createElement('img');
                    png.style.width = `${widthPx}px`;
                    png.style.height = `${heightPx}px`;
                    png.setAttribute('viewBox', `0 0 ${viewBoxWidth} ${viewBoxHeight}`);
                    png.src = path;

                    png.id = options.id ? options.id : '';
                    if (options.className) {
                        png.classList.add(options.className);
                    }
                    png.onclick = options.onclick ? options.onclick : null;

                    return png;
                };

                const applyFontColor = (font_color, background_color) => {

                    const all_others = document.getElementById("all_others");
                    const counting_number = document.getElementById("counting_number");
                    const fixed_part_of_utterance = document.getElementById("fixed_part_of_utterance");
                    const interim_part_of_utterance = document.getElementById("interim_part_of_utterance");
                    if (all_others) {
                        all_others.style.color = font_color;
                        all_others.style.backgroundColor = background_color;
                    }
                    if (counting_number) {
                        counting_number.style.color = font_color;
                        counting_number.style.backgroundColor = background_color;
                        counting_number.style.fontSize = "30px";

                    }
                    if (fixed_part_of_utterance) {
                        fixed_part_of_utterance.style.color = font_color;
                        fixed_part_of_utterance.style.backgroundColor = background_color;
                        fixed_part_of_utterance.style.fontSize = "30px";
                    }
                    if (interim_part_of_utterance) {
                        interim_part_of_utterance.style.color = font_color;
                        interim_part_of_utterance.style.backgroundColor = background_color;
                        interim_part_of_utterance.style.fontSize = "30px";
                    }

                }

                const addPxString = (outPxNumber) => {
                    let outputString = "";
                    outputString = outPxNumber.toString() + "px";
                    return outputString;
                }

                const applyOptionStyles = () => {

                    const all_others = document.getElementById("all_others");
                    const fixed_part_of_utterance = document.getElementById("fixed_part_of_utterance");
                    const buttons_for_command = document.getElementById("buttons");

                    let parsed_json = null;
                    let buttons_style_top = '0px';
                    let buttons_style_right = '100px';
                    let fixed_part_of_utterance_style_top = null;
                    let fixed_part_of_utterance_style_right = null;
                    let fixed_part_of_utterance_style_width = null;
                    let elem_others_style_top = '0px';
                    let elem_others_style_right = null;
                    let elem_others_style_width = null;
                    let z_index = 65000;
                    let factor_top = parseInt(1 * +1 * scrollY);
                    try {
                        parsed_json = JSON.parse(window_positions);
                        if ('buttons.style.top' in parsed_json) {
                            buttons_style_top = parseInt(parsed_json["buttons.style.top"]) + factor_top;
                        }
                        if ('buttons.style.right' in parsed_json) {
                            buttons_style_right = parsed_json["buttons.style.right"];
                        }
                        if ('fixed_part_of_utterance.style.right' in parsed_json) {
                            fixed_part_of_utterance_style_right = parsed_json["fixed_part_of_utterance.style.right"];
                        }
                        if ('fixed_part_of_utterance.style.top' in parsed_json) {
                            fixed_part_of_utterance_style_top = parseInt(parsed_json["fixed_part_of_utterance.style.top"]) + factor_top;
                        }
                        if ('fixed_part_of_utterance.style.width' in parsed_json) {
                            fixed_part_of_utterance_style_width = parsed_json["fixed_part_of_utterance.style.width"];
                        }
                        if ('elem_others.style.right' in parsed_json) {
                            elem_others_style_right = parsed_json["elem_others.style.right"];
                        }
                        if ('elem_others.style.top' in parsed_json) {
                            elem_others_style_top = parseInt(parsed_json["elem_others.style.top"]) + factor_top;
                        }
                        if ('elem_others.style.width' in parsed_json) {
                            elem_others_style_width = parsed_json["elem_others.style.width"];
                        }

                        if ('z_index' in parsed_json) {
                            z_index = parsed_json["z_index"];
                        }
                    } catch (e) {
                        console.log(`error window_positions parse:`, e);
                    }
                    if (all_others) {
                        all_others.style.zIndex = z_index;
                        all_others.style.top = addPxString(elem_others_style_top);
                        if (elem_others_style_right) {
                            all_others.style.right = elem_others_style_right;
                        }
                        if (elem_others_style_width) {
                            all_others.style.width = elem_others_style_width;
                        }
                    }
                    if (fixed_part_of_utterance) {
                        fixed_part_of_utterance.style.zIndex = z_index;
                        if (fixed_part_of_utterance_style_top) {
                            fixed_part_of_utterance.style.top = addPxString(fixed_part_of_utterance_style_top);
                        }
                        if (fixed_part_of_utterance_style_right) {
                            fixed_part_of_utterance.style.right = fixed_part_of_utterance_style_right;
                        }
                        if (fixed_part_of_utterance_style_width) {
                            fixed_part_of_utterance.style.width = fixed_part_of_utterance_style_width;
                        }
                    }
                    if (buttons_for_command) {
                        buttons_for_command.style.zIndex = z_index;
                        buttons_for_command.style.top = addPxString(buttons_style_top);
                        buttons_for_command.style.right = buttons_style_right;
                    }
                }

                const toast_to_notify = (input_text, duration) => {
                    let dialog = document.createElement('dialog');
                    dialog.innerHTML = input_text;
                    document.body.appendChild(dialog);
                    dialog.oncancel = function () {
                        dialog.remove();
                    }
                    dialog.showModal();
                    setTimeout(function () { dialog.remove(); }, duration);
                }

                ////////////////////////////////////////////////////////////////////////////
                // Main App
                ////////////////////////////////////////////////////////////////////////////

                console.log(`starting`);
                is_synced = null;
                // getAllStorageSyncData();
                addButtons();
                setInterval(tryTo(check_and_progress, 'utter check'), 500);
                window.addEventListener("scroll", (event) => {
                    applyOptionStyles();
                });

            })();

        } catch (e) {
            console.error('init error', e);
        }
                }
    </script>
</body>
</html>